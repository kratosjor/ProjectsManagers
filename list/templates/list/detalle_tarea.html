{% extends 'template_base.html' %}

{% block body %}

    <div class="container">
        <div class="task-detail">
            <h2>{{ tarea.tipo_tarea }} - {{ tarea.proyecto.nombre }}</h2>
            
            <div class="task-info">
                <!-- Informaci√≥n de la tarea aqu√≠... -->
            </div>

            <div class="task-actions">
                <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-primary">‚úèÔ∏è Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-danger">üóëÔ∏è Eliminar</a>
            </div>

            <!-- üîπ SECCI√ìN DE COMENTARIOS -->
                <div class="comments-section">
                    <h3>üìù Comentarios</h3>

                    <!-- Lista de comentarios -->
                    <div class="comments-list">
                        {% for comentario in tarea.comentarios.all %}
                            <div class="comment">
                                <p>
                                    <strong>{{ comentario.usuario.nombre }}</strong> - 
                                    {{ comentario.fecha_creacion|date:"m-d-y H:i" }}
                                </p>
                                <p class="comentario-contenido">{{ comentario.contenido|safe }}</p>

                                <!-- Bot√≥n para eliminar el comentario (solo si es el autor o un admin) -->
                                {% if comentario.usuario == user or user.is_staff %}
                                <form method="POST" action="{% url 'eliminar_comentario' comentario.id %}" style="display:inline;" onsubmit="return confirmarEliminacion();">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">üóëÔ∏è Eliminar</button>
                                </form>
                                {% endif %}
                            </div>
                        {% empty %}
                            <p>No hay comentarios a√∫n. ¬°S√© el primero en comentar! üòä</p>
                        {% endfor %}
                    </div>

                    <!-- Formulario para agregar comentario -->
                    {% if user.is_authenticated %}
                        <form id="comentario-form" method="POST" action="{% url 'agregar_comentario_tarea' proyect_id=tarea.proyecto.id tarea_id=tarea.id %}">
                            {% csrf_token %}
                            <textarea id="comentario-textarea" name="contenido" placeholder="Escribe tu comentario aqu√≠..." required></textarea>
                            <div id="menciones-sugerencias"></div>
                            <button type="submit" class="btn btn-success">üí¨ Comentar</button>
                        </form>
                    {% else %}
                        <p><a href="{% url 'login' %}">Inicia sesi√≥n</a> para comentar.</p>
                    {% endif %}
                </div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            let textarea = $("#comentario-textarea");
            let sugerencias = $("#menciones-sugerencias");
            let usuarios = [];
        
            // Obtener lista de usuarios desde el backend
            $.get("{% url 'obtener_usuarios' %}", function(data) {
                usuarios = data.usuarios;
            });
        
            // Mostrar sugerencias cuando se detecta "@"
            textarea.on("input", function() {
                let texto = textarea.val();
                let cursorPos = this.selectionStart;
                let palabraActual = texto.substring(0, cursorPos).match(/@\w*$/);
        
                if (palabraActual) {
                    let filtro = palabraActual[0].substring(1).toLowerCase();
                    let coincidencias = usuarios.filter(u => u.toLowerCase().startsWith(filtro));
        
                    sugerencias.html(coincidencias.map(u => `<div class="sugerencia">@${u}</div>`).join(""));
                    sugerencias.show();
                } else {
                    sugerencias.hide();
                }
            });
        
            // Insertar la menci√≥n seleccionada en el textarea
            $(document).on("click", ".sugerencia", function() {
                let seleccion = $(this).text();
                let texto = textarea.val();
                let cursorPos = textarea[0].selectionStart;
                let nuevoTexto = texto.substring(0, cursorPos).replace(/@\w*$/, seleccion) + texto.substring(cursorPos);
                
                textarea.val(nuevoTexto);
                sugerencias.hide();
                textarea.focus();
            });
        
            // Ocultar sugerencias cuando el usuario hace clic fuera
            $(document).click(function(e) {
                if (!$(e.target).closest("#menciones-sugerencias, #comentario-textarea").length) {
                    sugerencias.hide();
                }
            });
        
            // Enviar comentario usando AJAX
            $("#comentario-form").submit(function(e) {
                e.preventDefault();
        
                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },  // Protecci√≥n CSRF
                    success: function(response) {
                        if (response.error) {
                            alert(response.error);
                            return;
                        }
        
                        let contenidoConMenciones = response.contenido.replace(/@(\w+)/g, '<strong style="color:blue;">@$1</strong>');
        
                        $(".comments-list").append(`
                            <div class="comment">
                                <p><strong>${response.usuario}</strong> - ${response.fecha_creacion}</p>
                                <p>${contenidoConMenciones}</p>
                            </div>
                        `);
                        textarea.val("");  // Limpiar el textarea
                    },
                    error: function() {
                        alert("Hubo un error al agregar el comentario.");
                    }
                });
            });
        });
        document.addEventListener("DOMContentLoaded", function() {
            // Funci√≥n para resaltar correos electr√≥nicos
            const comentarios = document.querySelectorAll('.comentario-contenido');
    
            comentarios.forEach(function(comentario) {
                // Expresi√≥n regular para buscar correos electr√≥nicos
                const correoRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
    
                // Reemplazar los correos con un <span> que tenga la clase .email-highlight
                comentario.innerHTML = comentario.innerHTML.replace(correoRegex, function(match) {
                    return `<span class="email-highlight">${match}</span>`;
                });
            });
        });
        
        // Confirmaci√≥n de eliminaci√≥n
        function confirmarEliminacion() {
            return confirm("¬øEst√°s seguro de que deseas eliminar este comentario? Esta acci√≥n no se puede deshacer.");
        }
        
    </script>

    

{% endblock body %}
